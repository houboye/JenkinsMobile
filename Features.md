# Jenkins Mobile 功能设计文档

## 项目概述

Jenkins Mobile 是一个跨平台的 Jenkins 移动客户端，支持 iOS 和 Android 平台。使用现代化的 UI 框架（SwiftUI 和 Jetpack Compose）构建，提供原生的用户体验。

## 技术栈

| 平台 | UI 框架 | 语言 | 架构模式 |
|-----|---------|------|---------|
| iOS | SwiftUI | Swift | MVVM |
| Android | Jetpack Compose | Kotlin | MVVM |

## 核心功能

### 1. 服务器配置与登录

#### 功能描述
- 支持配置 Jenkins 服务器地址
- 支持用户名 + API Token 认证
- 自动保存登录状态，下次打开自动登录
- 支持退出登录

#### 技术实现
- **iOS**: 使用 UserDefaults 持久化存储
- **Android**: 使用 DataStore 持久化存储
- **认证方式**: HTTP Basic Auth (Base64 编码)

---

### 2. Dashboard（任务列表）

#### 功能描述
- 显示 Jenkins 服务器的所有 Views（视图）
- 支持切换不同 View 查看对应的任务列表
- 显示每个任务的状态（成功/失败/不稳定/构建中等）
- 显示任务健康度图标
- 支持下拉刷新
- 支持快速触发构建（自动检测是否需要参数）

#### 任务状态
| 状态 | 颜色 | 说明 |
|-----|------|-----|
| SUCCESS | 绿色 | 构建成功 |
| FAILURE | 红色 | 构建失败 |
| UNSTABLE | 黄色 | 构建不稳定 |
| DISABLED | 灰色 | 任务已禁用 |
| ABORTED | 灰色 | 构建已中止 |
| NOT_BUILT | 灰色 | 从未构建 |
| BUILDING | 蓝色+动画 | 正在构建 |

---

### 3. 任务详情

#### 功能描述
- 显示任务基本信息（名称、描述）
- 显示快速统计（最新构建、上次成功、上次失败）
- 显示构建历史列表
- 支持触发构建（自动检测是否需要参数）
- 支持下拉刷新
- 点击构建记录进入构建详情页

---

### 4. 构建详情（核心功能）

#### 功能描述
构建详情页面提供完整的构建信息查看和操作功能：

1. **查看构建状态**
   - 构建结果（成功/失败/不稳定/中止等）
   - 构建编号
   - 开始时间（精确到秒）
   - 构建耗时
   - 构建描述（如有）

2. **查看构建日志**
   - 完整的控制台输出
   - 等宽字体显示，保持日志格式
   - 深色背景，便于阅读
   - 支持文本选择和复制
   - 自动滚动到底部
   - 支持刷新获取最新日志

3. **查看构建参数**
   - 显示该构建使用的所有参数
   - 参数名和参数值清晰展示
   - 无参数时显示提示信息

4. **重新构建 (Rebuild)**
   - 使用相同参数重新触发构建
   - 如果任务有参数，弹出参数编辑页面
   - 预填充上次构建的参数值
   - 用户可修改参数后再触发构建
   - 无参数任务直接触发构建

5. **删除构建**
   - 删除当前构建记录
   - 删除前需二次确认
   - 删除成功后自动返回上一页

#### UI 设计
- 使用 Tab 切换三个视图：详情、日志、参数
- 日志视图背景色: #1E1E1E (深灰色)
- 日志文字色: #D4D4D4 (浅灰色)
- 日志字体: 等宽字体 (Monospace) 12sp/pt

---

### 5. 触发构建

#### 功能描述
- 支持无参数构建（直接触发）
- 支持参数化构建（显示参数填写界面）
- 自动获取并缓存 CSRF Token (Jenkins Crumb)
- 支持 Session Cookie 保持（确保 Crumb 有效）

#### 支持的参数类型
| 参数类型 | 控件 | 说明 |
|---------|------|-----|
| String | 文本输入框 | 单行文本 |
| Text | 多行文本框 | 多行文本 |
| Boolean | 开关 | 是/否选择 |
| Choice | 下拉选择 | 从预定义选项中选择 |
| Password | 密码输入框 | 隐藏输入内容 |

---

### 6. 设置页面

#### 功能描述
- 显示当前登录的服务器信息
- 显示当前登录的用户名
- 支持退出登录

---

## API 接口

### Jenkins REST API 使用

| 接口 | 方法 | 说明 |
|-----|------|-----|
| /api/json | GET | 获取服务器信息和视图列表 |
| /view/{name}/api/json | GET | 获取指定视图的任务列表 |
| /job/{name}/api/json | GET | 获取任务详情和构建历史 |
| /job/{name}/{build}/api/json | GET | 获取构建详情（含参数） |
| /job/{name}/buildWithParameters | POST | 触发构建（带参数） |
| /job/{name}/{build}/consoleText | GET | 获取构建日志 |
| /job/{name}/{build}/doDelete | POST | 删除构建 |
| /crumbIssuer/api/json | GET | 获取 CSRF Token |

---

## 页面导航流程

```
登录页 (LoginView)
    │
    ▼
Dashboard (DashboardView)
    │
    ├── 点击任务 ──► 任务详情 (JobDetailView)
    │                    │
    │                    ├── 点击构建记录 ──► 构建详情 (BuildDetailView)
    │                    │                        │
    │                    │                        ├── 详情 Tab: 状态信息 + 操作按钮
    │                    │                        ├── 日志 Tab: 控制台输出
    │                    │                        └── 参数 Tab: 构建参数
    │                    │
    │                    └── 点击触发构建 ──► [参数页面] ──► 触发
    │
    ├── 点击构建按钮 ──► [参数页面] ──► 触发
    │
    └── 点击设置 ──► 设置页 (SettingsView)
                        │
                        └── 退出登录 ──► 登录页
```

---

## UI/UX 设计原则

1. **iOS 设计语言**: 使用 iOS 原生设计风格
2. **一致性**: iOS 和 Android 界面保持 90% 以上相似度
3. **响应式**: 支持不同屏幕尺寸
4. **状态反馈**: 加载中显示进度指示器
5. **下拉刷新**: 所有列表支持下拉刷新
6. **深色模式**: 支持系统深色模式
7. **操作确认**: 危险操作需要二次确认

---

## 未来扩展

- [ ] 构建队列管理
- [ ] 构建通知推送
- [ ] 多服务器管理
- [ ] 搜索任务功能
- [ ] 构建统计图表
- [ ] Pipeline 可视化
- [ ] 构建取消功能
